# Xiaomi Router Firmware Pinger
This handy script (MiRF Pinger, in short) will ping Xiaomi router firmware server for the firmware version that you are anticipating exists for a certain router model. It will ping through the defined md5 hashes range and return the URL of the firmware version if found. It does so by spawning a number of sequential workers that ping their own hashes subrange to speed up the process. Each worker sends a request, waits for the server response and only after that recursively sends a subsequent request with a subsequent hash number. Upon sending a defined number of requests (a batch), the script will cache every worker ranges, total time spent, total requests made and number of rejected requests to the browser local storage, and then restart the workers with the subtracted ranges to release the memory occupied by the previous requests chains and dev console error logs. This will allow to run the script the next day from where you previously left and also not to consume all the available physical and virtual memory to the point where the browser hangs.

## The description of user-settable variables: </br>
- `rangeStart` - general start of the hashes range, default `0x10000`
- `rangeEnd` - general end of the hashes range, default `0xfffff`
- `modelID` - router model ID denoted on the chassis sticker, e.g. `"rd03"`
- `fwVersion` - target firmware to look for, e.g. `"1.0.92"`
- `chineseModel` -  default `true`, otherwise the URL for the router international version gets pinged
- `totalWorkers` - the number of workers that will be sending requests, e.g. `500`
- `workerSpawnInterval` - the time between spawning each subsequent worker, in milliseconds, e.g. `100`
- `minPostInterval` - the time between sending each subsequent request for a worker, in milliseconds, e.g. `3000`
- `requestsPerBatch` - the number of requests the workers batch will make before saving the updated ranges for each worker to the browser local storage and then respawning the workers to release memory, e.g. `10000`

## How to use
Set your user variables in the `ping-firmware.js` file. Drag and drop the `index.html` to the Firefox or Tor tab. The opened page will contain the number of convenience stats. Open the dev console to observe the log messages, some of which get duplicated on the stats page. The dev console will inevitably get overfilled with HTTP 404 error messages. You can turn off showing those errors in the dev console options for convenience. For that reason, the workers need to be restarted after reaching the defined requests batch to clear the console and release memory. As an additional countermeasure, there is a service worker added, `sw.js`, that will intercept the HTTP 404 errors and replace them with HTTP 202 responses, so that the dev console and memory don’t get overfilled. But for the service worker to do the intercepting work, you need to start a web server from the script folder root and then navigate to the localhost page in the browser. Having an active service worker is optional.

## Reading the stats page
For keeping track of progress and reminding what user values you have set, the major values from `ping-firmware.js` file get shown on the stats page. Occasionally the firmware server will reject requests and the number of rejects is also counted for comparison with the successful ones. The rejected requests will get retried after the workers restart and aren’t added to the total requests count. Once all workers finish with their ranges, the stats page will denote that with the "Finished" message at the page bottom and the local storage cache will get deleted to allow a firmware search from scratch with the updated user variables on page refresh. Once the firmware URL gets found at some point, it will get displayed along the "Finished" message.

## Personal notes
- Make sure your browser cache is enabled and not in a private/incognito tab to retain your progress in the local storage between runs.
- Chrome happens to not return the HTTP 200 response for a well-known firmware URL, e.g. "*https://<area>cdn.cnbj1.fds.api.mi-img.com/xiaoqiang/rom/rd03/miwifi_rd03_firmware_7df60_1.0.91.bin*" for the "rd03" model. Seems you need to manually navigate to the Xiaomi router firmware server web page, "*https://<area>cdn.cnbj1.fds.api.mi-img.com/fds-storage/pc/index.html*", and from there paste the `ping-firmware.js` file contents to the dev console, commenting out lines as needed, thus losing the benefit of the stats page and the service worker. Firefox and Tor did not exhibit such an issue.
- The total workers number set to 500 and the time between requests set to 3 seconds is already enough to saturate the firmware server. Setting total workers to 1000 and the time between requests to 1 second does not increase much the number of responses received from the firmware server in a 2-minute timeframe. From observation, the firmware server can return around 10500 responses in a 2-minute timeframe.
- It is convenient to run the script in Firefox on Android. For this you need to open the `index.html` from the "File Manager +" app that has HTTP server integrated into it. Or download the HTTP server app separately, start it from the script folder and navigate to the localhost web page.
- Refreshing the stats page while the script is working will restart the whole workers batch and sometimes cause the interrupted batch to have 500 pending requests rejected at once, as will be shown on the stats page.
- Total requests made happen to exceed the number of total hashes by 100000±. I have not figured out why, but releasing the script as is, since it is robust enough.
- For reference, the maximum time it took me to cover the [0x10000 - 0xfffff] range, or 983040 hashes, with 500 workers and 3 seconds between requests, was 248 minutes. The minimum was 150 minutes.
- Tor browser is restricted from opening localhost URLs, thus the script won't run with the active service worker.
